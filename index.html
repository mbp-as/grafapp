<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, minimum-scale=1">
<title>Камера з графікою</title>
<style>
html, body {
  margin: 0; padding: 0; overflow: hidden; height: 100%; background: black;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  touch-action: manipulation;
  overscroll-behavior: none;
}
* { touch-action: manipulation; }
#container {
  position: absolute;
  width: 100vh;  
  height: 100vw; 
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(90deg);
  transform-origin: center center;
}
video, #overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  height: 100%;
  width: auto;
  object-fit: contain;
  border-radius: 12px;
}

/* Кнопка затвору - велика */
#captureBtn {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  width: 240px;
  height: 240px;
  border-radius: 50%;
  background: rgba(255,255,255,0.95);
  border: none;
  box-shadow: 0 6px 15px rgba(0,0,0,0.35);
  cursor: pointer;
  z-index: 20;
}

/* Кнопка add.svg під затвором */
#menuBtn {
  position: absolute;
  right: 15px;
  top: calc(50% + 140px);
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(255,255,255,0.95);
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 20;
  display: flex;
  justify-content: center;
  align-items: center;
}
#menuBtn img { width: 50%; height: 50%; }

/* Кнопка наступного графа вправо */
#nextGraphBtn {
  position: absolute;
  right: 15px;
  top: calc(50% - 200px);
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: #007aff;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 20;
  display: flex;
  justify-content: center;
  align-items: center;
}
#nextGraphBtn img { width: 50%; height: 50%; }

/* Кнопка графа вліво */
#prevGraphBtn {
  position: absolute;
  right: 130px; /* віддалено від затвору */
  top: calc(50% - 200px);
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: #007aff;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 20;
  display: flex;
  justify-content: center;
  align-items: center;
}
#prevGraphBtn img { width: 50%; height: 50%; }

/* Меню контролів */
#controls {
  position: absolute;
  top: 50%;
  left: 25px;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.95);
  padding: 40px 50px;
  border-radius: 30px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: center;
  display: none;
  z-index: 15;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  width: 400px;
}

/* Селект та кнопки iOS стиль */
#controls select, #controls button { 
  font-size: 22px; padding: 15px 20px; border-radius: 18px; border: 1px solid #ccc; width: 100%; text-align: center;
  background: #f2f2f7;
}
#controls select:focus, #controls button:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,122,255,0.3); }

#closeControls { align-self: flex-end; font-size: 28px; cursor: pointer; margin-bottom: 5px; }

#zoomControls { display: flex; gap: 15px; }
#zoomControls button {
  width: 60px;
  height: 60px;
  font-size: 32px;
  border-radius: 50%;
  border: none;
  background: #f2f2f7;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}
#zoomControls button:hover { box-shadow: 0 5px 12px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<div id="container">
  <video id="camera" autoplay playsinline></video>
  <img id="overlay" src="graf0.png">
  
  <div id="captureBtn"></div>
  <button id="nextGraphBtn"><img src="arrow.svg" alt="next"></button>
  <button id="prevGraphBtn"><img src="arrow1.svg" alt="prev"></button>
  <button id="menuBtn"><img src="add.svg" alt="add"></button>
  
  <div id="controls">
    <div id="closeControls">✕</div>
    <select id="imageSelect"></select>
    <button id="switchCam">Перевернути камеру</button>
    <button id="rotateCam">Повернути відео</button>
    <div id="zoomControls">
      <button id="zoomIn">+</button>
      <button id="zoomOut">-</button>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('camera');
const overlay = document.getElementById('overlay');
const select = document.getElementById('imageSelect');
const switchCamBtn = document.getElementById('switchCam');
const rotateCamBtn = document.getElementById('rotateCam');
const captureBtn = document.getElementById('captureBtn');
const menuBtn = document.getElementById('menuBtn');
const controls = document.getElementById('controls');
const closeControls = document.getElementById('closeControls');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const nextGraphBtn = document.getElementById('nextGraphBtn');
const prevGraphBtn = document.getElementById('prevGraphBtn');

let currentFacing = 'environment';
let videoRotation = 0;
let videoScale = 1;
let graphIndex = 0;
let graphs = [];

function updateVideoTransform() {
  video.style.transform = `translate(-50%, -50%) scale(${videoScale}) rotate(${videoRotation}deg)`;
}

async function startCamera() {
  if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: currentFacing } }, audio: false });
    video.srcObject = stream;
  } catch(err) { console.error("Помилка доступу до камери:", err); }
}

async function detectGraphs() {
  const maxFiles = 16; // від 0 до 15
  for(let i=0; i<maxFiles; i++){
    const url = `graf${i}.png`;
    try {
      await fetch(url, { method: 'HEAD' });
      const opt = document.createElement('option');
      opt.value = url;
      opt.text = `Graf ${i}`;
      select.appendChild(opt);
      graphs.push(url);
      if(i===0){ overlay.src = url; select.value = url; }
    } catch(e){ }
  }
}

switchCamBtn.addEventListener('click', ()=>{ currentFacing = currentFacing==='environment'?'user':'environment'; startCamera(); });
rotateCamBtn.addEventListener('click', ()=>{ videoRotation = (videoRotation + 90) % 360; updateVideoTransform(); });
zoomInBtn.addEventListener('click', ()=>{ videoScale += 0.1; updateVideoTransform(); });
zoomOutBtn.addEventListener('click', ()=>{ videoScale = Math.max(0.1, videoScale - 0.1); updateVideoTransform(); });
select.addEventListener('change', ()=>{ overlay.src = select.value; });
menuBtn.addEventListener('click', ()=>controls.style.display='flex');
closeControls.addEventListener('click', ()=>controls.style.display='none');

nextGraphBtn.addEventListener('click', ()=>{
  if(graphs.length===0) return;
  graphIndex = (graphIndex+1)%graphs.length;
  overlay.src = graphs[graphIndex];
  select.value = overlay.src;
});

prevGraphBtn.addEventListener('click', ()=>{
  if(graphs.length===0) return;
  graphIndex = (graphIndex-1+graphs.length)%graphs.length;
  overlay.src = graphs[graphIndex];
  select.value = overlay.src;
});

captureBtn.addEventListener('click', async ()=>{
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  const overlayImg = new Image();
  overlayImg.src = overlay.src;
  await overlayImg.decode();
  const canvas = document.createElement('canvas');
  canvas.width = Math.max(vh, overlayImg.width);
  canvas.height = overlayImg.height + vw;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(overlayImg, 0, 0, canvas.width, overlayImg.height);
  ctx.save();
  ctx.translate(0, overlayImg.height + vw);
  ctx.rotate(-Math.PI/2);
  ctx.drawImage(video, 0, 0, vw, vh);
  ctx.restore();
  const imgData = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = imgData;
  a.download = 'photo.png';
  a.click();
});

startCamera();
detectGraphs();
</script>
</body>
</html>
