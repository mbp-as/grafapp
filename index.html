<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Моя Камера</title>

<!-- PWA -->
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;:&quot;Моя Камера&quot;,
  &quot;short_name&quot;:&quot;Камера&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#000000&quot;,
  &quot;theme_color&quot;:&quot;#000000&quot;,
  &quot;icons&quot;:[
    {&quot;src&quot;:&quot;icon-192.png&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;},
    {&quot;src&quot;:&quot;icon-512.png&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/png&quot;}
  ]
}">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Моя Камера">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body { margin:0; background:black; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }
#camera-container { position:relative; width:100vw; height:100vh; overflow:hidden; }
video { width:100%; height:100%; object-fit:cover; }
#graph { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; object-fit:contain; }
#controls { position:absolute; right:10px; bottom:15%; display:flex; flex-direction:column; align-items:center; gap:15px; cursor:move; background:rgba(0,0,0,0.3); padding:10px; border-radius:15px; }
.control-btn, .side-btn { width:60px; height:60px; border-radius:50%; background:rgba(255,255,255,0.9); display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.4); }
.control-btn img, .side-btn img { width:28px; height:28px; }
#shutter { width:80px; height:80px; background:white; }
.side-btn img { width:24px; height:24px; }
#settings-panel { position:absolute; left:10px; bottom:10%; width:220px; padding:15px; background:rgba(255,255,255,0.95); border-radius:20px; box-shadow:0 2px 10px rgba(0,0,0,0.3); display:flex; flex-direction:column; gap:10px; }
#settings-panel button, #settings-panel select { padding:8px 12px; border-radius:10px; border:none; background:#f2f2f7; font-size:14px; }
#settings-toggle { position:absolute; left:15px; bottom:5%; width:60px; height:60px; border-radius:50%; background:rgba(255,255,255,0.9); display:flex; align-items:center; justify-content:center; }
#settings-toggle img { width:28px; height:28px; }
</style>
</head>
<body>
<div id="camera-container">
  <video id="camera" autoplay playsinline></video>
  <img id="graph" src="graf0.png">

  <!-- Панель праворуч draggable -->
  <div id="controls">
    <button id="prevGraph" class="side-btn"><img src="arror1.svg"></button>
    <button id="nextGraph" class="side-btn"><img src="arror.svg"></button>
    <button id="lensSwitch" class="control-btn"><img id="lensIcon" src="1x.svg"></button>
    <button id="shutter" class="control-btn"><img src="camera.svg"></button>
  </div>

  <!-- Панель налаштувань -->
  <div id="settings-panel">
    <select id="graphSelect"></select>
    <button id="flipCamera"><img src="camflip.svg" width="20"></button>
    <button id="rotateCamera"><img src="camrot.svg" width="20"></button>
    <button id="zoomIn"><img src="zoomin.svg" width="20"></button>
    <button id="zoomOut"><img src="zoomout.svg" width="20"></button>
    <button id="pageZoomIn">Масштаб +</button>
    <button id="pageZoomOut">Масштаб -</button>
  </div>
  <button id="settings-toggle"><img src="add.svg"></button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video=document.getElementById("camera");
const graph=document.getElementById("graph");
const shutter=document.getElementById("shutter");
const flipCameraBtn=document.getElementById("flipCamera");
const rotateCameraBtn=document.getElementById("rotateCamera");
const zoomInBtn=document.getElementById("zoomIn");
const zoomOutBtn=document.getElementById("zoomOut");
const prevGraphBtn=document.getElementById("prevGraph");
const nextGraphBtn=document.getElementById("nextGraph");
const lensSwitch=document.getElementById("lensSwitch");
const lensIcon=document.getElementById("lensIcon");
const settingsToggle=document.getElementById("settings-toggle");
const settingsPanel=document.getElementById("settings-panel");
const graphSelect=document.getElementById("graphSelect");
const pageZoomIn=document.getElementById("pageZoomIn");
const pageZoomOut=document.getElementById("pageZoomOut");

let currentGraph=0, facingMode="environment", rotation=0, zoom=1, pageZoom=1;
let lensModes=["05.svg","1x.svg","2x.svg"], lensIndex=1;
let stream, track;

// Заповнення select графіків
for(let i=0;i<=15;i++){ const opt=document.createElement("option"); opt.value=i; opt.textContent=`graf${i}`; graphSelect.appendChild(opt); }

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  const constraints={video:{facingMode,width:{ideal:4096},height:{ideal:2160}}};
  stream=await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject=stream;
  track=stream.getVideoTracks()[0];
}
startCamera();

// Графіки
nextGraphBtn.onclick=()=>{ currentGraph=(currentGraph+1)%16; graph.src=`graf${currentGraph}.png`; graphSelect.value=currentGraph; };
prevGraphBtn.onclick=()=>{ currentGraph=(currentGraph-1+16)%16; graph.src=`graf${currentGraph}.png`; graphSelect.value=currentGraph; };
graphSelect.onchange=()=>{ currentGraph=parseInt(graphSelect.value); graph.src=`graf${currentGraph}.png`; };

// Кнопки камери
flipCameraBtn.onclick=()=>{ facingMode=facingMode==="environment"?"user":"environment"; startCamera(); };
rotateCameraBtn.onclick=()=>{ rotation=(rotation+90)%360; video.style.transform=`rotate(${rotation}deg) scale(${zoom})`; };
zoomInBtn.onclick=()=>{ zoom+=0.1; video.style.transform=`rotate(${rotation}deg) scale(${zoom})`; };
zoomOutBtn.onclick=()=>{ zoom=Math.max(0.5,zoom-0.1); video.style.transform=`rotate(${rotation}deg) scale(${zoom})`; };

// Кнопка затвору
shutter.onclick=()=>{
  const canvas=document.getElementById("canvas");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight+graph.height;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(graph,0,0,canvas.width,graph.height);
  ctx.drawImage(video,0,graph.height,canvas.width,video.videoHeight);
  const link=document.createElement("a");
  link.download="photo.png";
  link.href=canvas.toDataURL("image/png",1.0);
  link.click();
};

// Кнопка об'єктива
lensSwitch.onclick=()=>{
  lensIndex=(lensIndex+1)%lensModes.length;
  lensIcon.src=lensModes[lensIndex];
  if(track&&track.getCapabilities().zoom){
    track.applyConstraints({advanced:[{zoom:[0.5,1,2][lensIndex]}]});
  }
};

// Налаштування
settingsToggle.onclick=()=>{ settingsPanel.style.display=settingsPanel.style.display==="flex"?"none":"flex"; };
settingsPanel.style.display="flex";

// Масштаб сторінки
pageZoomIn.onclick=()=>{ pageZoom+=0.1; document.body.style.zoom=pageZoom; };
pageZoomOut.onclick=()=>{ pageZoom=Math.max(0.5,pageZoom-0.1); document.body.style.zoom=pageZoom; };

// Drag панелі
const controls=document.getElementById("controls");
let isDragging=false, offsetX=0, offsetY=0;
controls.addEventListener("mousedown",e=>{ isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
document.addEventListener("mousemove",e=>{ if(isDragging){ controls.style.left=(e.clientX-offsetX)+"px"; controls.style.top=(e.clientY-offsetY)+"px"; }});
document.addEventListener("mouseup",()=>{ isDragging=false; });

// Заборона подвійного масштабування
document.addEventListener('gesturestart', e=>e.preventDefault());

// Service Worker (інлайн)
if("serviceWorker" in navigator){
  const swCode=`self.addEventListener('install',e=>{e.waitUntil(caches.open('pwa-cache').then(c=>c.addAll(['/'])));});
  self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;
  const blob=new Blob([swCode],{type:"application/javascript"});
  const swUrl=URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
</script>
</body>
</html>
