<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Camera Overlay App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:sans-serif; background:#000; display:flex; justify-content:center; align-items:center; min-height:100vh; }
    .app { background:#fff; border-radius:20px; display:flex; overflow:hidden; width:100%; max-width:1000px; height:520px; }
    .viewfinder { flex:1; position:relative; background:#000; }
    video, canvas { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
    .panel { width:300px; background:#fff; display:flex; flex-direction:column; padding:16px; gap:12px; }
    .controls { display:flex; justify-content:space-between; align-items:center; }
    .btn { border:none; cursor:pointer; }
    .circle { width:40px; height:40px; border-radius:50%; background:#3b82f6; color:#fff; font-size:18px; display:flex; align-items:center; justify-content:center; }
    .number { width:60px; height:60px; border-radius:12px; background:#f3f3f3; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px; cursor:pointer; }
    .preview { flex:1; display:flex; align-items:center; justify-content:center; background:#e5e5e5; border-radius:12px; overflow:hidden; }
    .action { padding:12px; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; }
    .shutter { background:#fee2e2; color:#ef4444; }
    .clear { background:#fdf2f8; color:#db2777; }
    .note { font-size:12px; color:#666; text-align:center; }
  </style>
</head>
<body>
  <div class="app">
    <div class="viewfinder">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
    </div>
    <div class="panel">
      <div class="controls">
        <button id="prev" class="btn circle">‚óÄ</button>
        <div id="number" class="number">1</div>
        <button id="next" class="btn circle">‚ñ∂</button>
      </div>
      <div class="preview">
        <img id="previewImg" style="max-width:100%; max-height:100%; display:none;">
        <span id="previewText">–ì—Ä–∞—Ñ—ñ–∫: graf1.png</span>
      </div>
      <button id="shutter" class="action shutter">üì∏ –ó–∞—Ç–≤–æ—Ä</button>
      <button id="clear" class="action clear">–û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
      <div class="note">–ü—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –Ω–æ–º–µ—Ä–∞ –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ –∑'—è–≤–∏—Ç—å—Å—è, –¥–æ–∫–∏ –Ω–µ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ –Ω–∞ –±–ª–æ–∫ –∑ —Ü–∏—Ñ—Ä–æ—é.</div>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const previewImg = document.getElementById("previewImg");
    const previewText = document.getElementById("previewText");
    const numberBlock = document.getElementById("number");

    let index = 1;
    const grafCount = 4; // —Å–∫—ñ–ª—å–∫–∏ —î graf?.png
    let overlayVisible = false;
    let overlayImg = null;

    // –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false })
      .then(stream => { video.srcObject = stream; })
      .catch(e => console.error(e));

    // –º–∞–ª—é–≤–∞–Ω–Ω—è –≤—ñ–¥–µ–æ + –Ω–∞–∫–ª–∞–¥–∫–∏
    function draw() {
      if (video.videoWidth) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (overlayVisible && overlayImg) {
          ctx.drawImage(overlayImg, 0, 0, canvas.width, canvas.height);
        }
      }
      requestAnimationFrame(draw);
    }
    draw();

    function loadOverlay() {
      const img = new Image();
      img.src = `graf${index}.png`;
      img.onload = () => { overlayImg = img; previewImg.src = img.src; previewImg.style.display="block"; previewText.style.display="none"; };
      img.onerror = () => { overlayImg=null; previewImg.style.display="none"; previewText.style.display="block"; previewText.textContent = `–ì—Ä–∞—Ñ—ñ–∫: graf${index}.png`; };
    }
    loadOverlay();

    document.getElementById("prev").onclick = () => { index = index<=1?grafCount:index-1; numberBlock.textContent=index; loadOverlay(); };
    document.getElementById("next").onclick = () => { index = index>=grafCount?1:index+1; numberBlock.textContent=index; loadOverlay(); };

    numberBlock.onclick = () => { overlayVisible=!overlayVisible; };
    document.getElementById("clear").onclick = () => { overlayVisible=false; };

    document.getElementById("shutter").onclick = () => {
      const w = video.videoWidth || 640, h = video.videoHeight || 480;
      const tmp = document.createElement("canvas");
      tmp.width = w; tmp.height = h*2;
      const tctx = tmp.getContext("2d");

      // –∑ –Ω–∞–∫–ª–∞–¥–∫–æ—é
      tctx.drawImage(video, 0, 0, w, h);
      if (overlayImg) tctx.drawImage(overlayImg, 0, 0, w, h);

      // –±–µ–∑ –Ω–∞–∫–ª–∞–¥–∫–∏
      tctx.drawImage(video, 0, h, w, h);

      tmp.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href=url; a.download=`photo_graf${index}.png`; a.click();
        URL.revokeObjectURL(url);
      });
    };
  </script>
</body>
</html>
